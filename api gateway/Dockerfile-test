# Use Gradle image with JDK 21
FROM gradle:8.10.2-jdk21 as builder

# Set the working directory inside the container
WORKDIR /opt/app

# Copy Gradle wrapper and build scripts to the container
COPY ./gradlew ./gradlew
COPY ./gradle ./gradle
COPY ./build.gradle ./build.gradle
COPY ./settings.gradle ./settings.gradle

# Copy the entire source code into the container
COPY ./src ./src

# Build the application
RUN ./gradlew build --no-daemon

# Use a smaller base image for the runtime environment
FROM gradle:8.10.2-jdk21

# Set the working directory
WORKDIR /opt/app

# Copy the JAR file from the builder stage
COPY --from=builder /opt/app/build/libs/api_gateway-0.0.1-SNAPSHOT.jar ./api_gateway-0.0.1-SNAPSHOT.jar

# Copy any additional resources
COPY ./src/main/resources/jwt_certs ./jwt_certs

# Expose the application port
EXPOSE 8080

# Set the entry point to run the JAR file with optional JAVA_OPTS
ENTRYPOINT ["sh", "-c", "java ${JAVA_OPTS} -jar api_gateway-0.0.1-SNAPSHOT.jar --spring.profiles.active=test"]
